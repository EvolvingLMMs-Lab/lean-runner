---

## Code Generation

To generate the Go gRPC code from the `.proto` files, you need to have `protoc`, `protoc-gen-go`, and `protoc-gen-go-grpc` installed.

Run the following command from the project's root directory to generate the files into the `packages/server/gen/go/` directory:

```bash
protoc --go_out=./packages/server/gen/go --go_opt=paths=source_relative \
       --go-grpc_out=./packages/server/gen/go --go-grpc_opt=paths=source_relative \
       ./proto/lean_runner/*.proto
```

## Server Code Structure

This document outlines the code structure for the Go server.

### Directory Layout

```
server/
├── cmd/
│   └── server/
│       └── main.go
├── internal/
│   ├── server/
│   │   └── server.go
│   └── service/
│       └── prove_service.go
├── pkg/
│   └── lean/
│       └── runner.go
├── gen/
│   └── go/
│       └── ...
├── go.mod
└── go.sum
```

### File Descriptions

#### `cmd/server/main.go`

*   **Purpose:** The main entry point for the server application.
*   **Responsibilities:**
    *   Parse command-line flags and arguments.
    *   Load application configuration (e.g., from a file or environment variables).
    *   Initialize the logger.
    *   Establish a database connection.
    *   Create a new gRPC server instance.
    *   Register the gRPC services (e.g., `ProveService`).
    *   Start the gRPC server and listen for incoming connections.

#### `internal/server/server.go`

*   **Purpose:** Defines and manages the gRPC server.
*   **Responsibilities:**
    *   Define the `Server` struct, which holds dependencies like the database connection and registered services.
    *   Contain the logic for starting and gracefully shutting down the gRPC server.
    *   Handle server-level concerns like interceptors for logging, authentication, and metrics.

#### `internal/service/prove_service.go`

*   **Purpose:** Implements the `ProveService` gRPC service defined in `prove.proto`.
*   **Responsibilities:**
    *   Contain the core business logic for handling proof requests.
    *   Receive requests from the gRPC server.
    *   Interact with the `lean.Runner` to execute Lean proofs.
    *   Process the results from the Lean runner.
    *   Return the proof results or any errors to the client.

#### `pkg/lean/runner.go`

*   **Purpose:** Provides an interface for interacting with the Lean prover.
*   **Responsibilities:**
    *   Manage the lifecycle of the Lean process (start, stop, restart).
    *   Send Lean code to the running process for execution.
    *   Read and parse the output from the Lean process (e.g., proof status, errors).
    *   Abstract the details of the Lean interaction, so the rest of the application doesn't need to know about the underlying process management.

#### `gen/go/`

*   **Purpose:** Contains the Go code automatically generated by `protoc` from the `.proto` files.
*   **Contents:**
    *   gRPC service definitions.
    *   Message structs.
    *   Client and server stubs.
*   **Note:** This code should not be manually edited. Any changes should be made to the `.proto` files, and then the code should be regenerated.
